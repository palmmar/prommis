@page "{id:int}"
@model StegStat.Pages.Groups.DetailsModel
@{
    ViewData["Title"] = Model.Group?.Name ?? "Grupp";
}

@if (Model.Group is null)
{
    <div class="rounded-2xl border border-slate-200 bg-white p-6">Gruppen hittades inte.</div>
}
else
{
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
            <p class="text-sm text-slate-500">Grupp</p>
            <h1 class="text-3xl font-semibold">@Model.Group.Name</h1>
            <p class="mt-2 text-sm text-slate-500">Ägare: @Model.Group.Owner?.UserName</p>
        </div>
        @if (Model.IsOwner)
        {
            <form method="post" asp-page-handler="CreateInvite">
                <button type="submit" class="rounded-full bg-accent px-4 py-2 text-sm font-semibold text-white hover:bg-teal-700">Skapa inbjudningslänk</button>
            </form>
        }
    </div>

    <section class="mt-8 grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
        <div class="grid gap-4">
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600">Senaste veckan</h3>
                <canvas id="weekChart" class="mt-4 h-48 w-full"></canvas>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600">Månad</h3>
                <canvas id="monthChart" class="mt-4 h-48 w-full"></canvas>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600">Senaste 12 månaderna</h3>
                <canvas id="yearChart" class="mt-4 h-48 w-full"></canvas>
            </div>
        </div>

        <div class="grid gap-4">
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600">Medlemmar</h3>
                <div class="mt-4 grid gap-3">
                    @foreach (var member in Model.Memberships)
                    {
                        <div class="flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-slate-200 p-4">
                            <div>
                                <p class="font-semibold">@member.User?.UserName</p>
                                <p class="text-xs text-slate-500">@member.Role</p>
                            </div>
                            @if (Model.IsOwner && member.Role != GroupRole.Owner)
                            {
                                <div class="flex items-center gap-2">
                                    <form method="post" asp-page-handler="TransferOwnership">
                                        <input type="hidden" name="newOwnerId" value="@member.UserId" />
                                        <button type="submit" class="rounded-full border border-slate-300 px-3 py-1 text-xs text-slate-600 hover:border-slate-400">Gör till ägare</button>
                                    </form>
                                    <form method="post" asp-page-handler="RemoveMember">
                                        <input type="hidden" name="memberId" value="@member.UserId" />
                                        <button type="submit" class="rounded-full border border-rose-200 px-3 py-1 text-xs text-rose-600 hover:border-rose-300">Ta bort</button>
                                    </form>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-600">Aktiva inbjudningar</h3>
                <div class="mt-4 grid gap-3">
                    @if (Model.ActiveInvites.Count == 0)
                    {
                        <div class="rounded-2xl bg-mist p-4 text-sm text-slate-500">Inga aktiva inbjudningar.</div>
                    }
                    else
                    {
                        @foreach (var invite in Model.ActiveInvites)
                        {
                            var inviteUrl = Url.Page(
                                "/Invites/Accept",
                                pageHandler: null,
                                values: new { token = invite.Token },
                                protocol: Request.Scheme
                            );
                            <div class="rounded-2xl border border-slate-200 p-4">
                                <p class="text-xs text-slate-500">Gäller till @invite.ExpiresAt.ToLocalTime():g</p>
                                <input type="text" readonly value="@inviteUrl" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-xs" />
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </section>
}

@section Scripts
{
    @if (Model.Group is not null)
    {
        <script>
            const buildLine = (ctx, labels, data) => new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: "#0f766e",
                        backgroundColor: "rgba(15, 118, 110, 0.15)",
                        tension: 0.3,
                        pointRadius: 3,
                        fill: true
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    }
                }
            });

            buildLine(
                document.getElementById("weekChart"),
                @Html.Raw(Model.WeekLabelsJson),
                @Html.Raw(Model.WeekValuesJson)
            );
            buildLine(
                document.getElementById("monthChart"),
                @Html.Raw(Model.MonthLabelsJson),
                @Html.Raw(Model.MonthValuesJson)
            );
            buildLine(
                document.getElementById("yearChart"),
                @Html.Raw(Model.YearLabelsJson),
                @Html.Raw(Model.YearValuesJson)
            );
        </script>
    }
}
