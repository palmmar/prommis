@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

@if (!Model.IsSignedIn)
{
    <section class="grid gap-8 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
            <p class="text-sm font-medium uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">Steg för steg</p>
            <h1 class="mt-4 text-4xl font-semibold leading-tight">Följ dina steg och bygg vanor tillsammans.</h1>
            <p class="mt-4 text-slate-600 dark:text-slate-300">
                Skapa grupper, samla steg varje dag och se hur ni växer vecka för vecka.
            </p>
            <div class="mt-6 flex flex-wrap gap-3">
                <a class="rounded-full bg-ink px-5 py-2 text-white hover:bg-slate-800 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white" asp-area="Identity" asp-page="/Account/Register">
                    Skapa konto
                </a>
                <a class="rounded-full border border-slate-300 px-5 py-2 text-slate-700 hover:border-slate-400 dark:border-slate-700 dark:text-slate-200 dark:hover:border-slate-500" asp-area="Identity" asp-page="/Account/Login">
                    Logga in
                </a>
            </div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
            <h2 class="text-lg font-semibold">Vad du får</h2>
            <ul class="mt-4 grid gap-3 text-sm text-slate-600 dark:text-slate-300">
                <li class="rounded-2xl bg-mist p-4 dark:bg-slate-800/70">Tre grafer: vecka, månad, år.</li>
                <li class="rounded-2xl bg-mist p-4 dark:bg-slate-800/70">Flera poster per dag, redigera samma dag.</li>
                <li class="rounded-2xl bg-mist p-4 dark:bg-slate-800/70">Grupper med anonym totalsumma.</li>
            </ul>
        </div>
    </section>
}
else
{
    <section class="grid gap-6 lg:grid-cols-[1.05fr_0.95fr]">
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Dina steg idag</p>
                    <h2 class="text-3xl font-semibold">@Model.TodayTotalSteps steg</h2>
                </div>
                <form method="post" asp-page-handler="AddStep" class="flex items-center gap-2">
                    <input name="steps" type="number" min="1" class="w-32 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm text-slate-900 placeholder:text-slate-400 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:placeholder:text-slate-500" placeholder="Steg" required />
                    <button type="submit" class="rounded-full bg-accent px-4 py-2 text-sm font-semibold text-white hover:bg-teal-700">Lägg till</button>
                </form>
            </div>
            <div class="mt-6">
                <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">Dagens poster</h3>
                <div class="mt-3 grid gap-3">
                    @if (Model.TodayEntries.Count == 0)
                    {
                        <div class="rounded-2xl bg-mist p-4 text-sm text-slate-500 dark:bg-slate-800/70 dark:text-slate-400">Inga steg registrerade ännu.</div>
                    }
                    else
                    {
                        @foreach (var entry in Model.TodayEntries)
                        {
                            <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 p-4 dark:border-slate-800">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">@entry.CreatedAt.ToLocalTime().ToString("HH:mm")</p>
                                    <p class="text-lg font-semibold">@entry.Steps steg</p>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                    <form method="post" asp-page-handler="EditStep" class="flex items-center gap-2">
                                        <input type="hidden" name="entryId" value="@entry.Id" />
                                        <input name="steps" type="number" min="1" value="@entry.Steps" class="w-24 rounded-full border border-slate-300 bg-white px-3 py-1 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100" />
                                        <button type="submit" class="rounded-full border border-slate-300 px-3 py-1 text-sm text-slate-600 hover:border-slate-400 dark:border-slate-700 dark:text-slate-200 dark:hover:border-slate-500">Spara</button>
                                    </form>
                                    <form method="post" asp-page-handler="DeleteStep">
                                        <input type="hidden" name="entryId" value="@entry.Id" />
                                        <button type="submit" class="rounded-full border border-rose-200 px-3 py-1 text-sm text-rose-600 hover:border-rose-300 dark:border-rose-900/60 dark:text-rose-300 dark:hover:border-rose-700">Ta bort</button>
                                    </form>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="grid gap-4">
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
                <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">Senaste veckan</h3>
                <canvas id="weekChart" class="mt-4 h-48 w-full"></canvas>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
                <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">Månad</h3>
                <canvas id="monthChart" class="mt-4 h-48 w-full"></canvas>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
                <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">Senaste 12 månaderna</h3>
                <canvas id="yearChart" class="mt-4 h-48 w-full"></canvas>
            </div>
        </div>
    </section>
}

@section Scripts
{
    @if (Model.IsSignedIn)
    {
        <script>
            const isDark = document.documentElement.classList.contains("dark");
            Chart.defaults.color = isDark ? "#cbd5f5" : "#0f172a";
            Chart.defaults.borderColor = isDark ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.35)";

            const buildLine = (ctx, labels, data) => new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: "#0f766e",
                        backgroundColor: isDark ? "rgba(13, 148, 136, 0.25)" : "rgba(15, 118, 110, 0.15)",
                        tension: 0.3,
                        pointRadius: 3,
                        fill: true
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    }
                }
            });

            buildLine(
                document.getElementById("weekChart"),
                @Html.Raw(Model.WeekLabelsJson),
                @Html.Raw(Model.WeekValuesJson)
            );
            buildLine(
                document.getElementById("monthChart"),
                @Html.Raw(Model.MonthLabelsJson),
                @Html.Raw(Model.MonthValuesJson)
            );
            buildLine(
                document.getElementById("yearChart"),
                @Html.Raw(Model.YearLabelsJson),
                @Html.Raw(Model.YearValuesJson)
            );
        </script>
    }
}
